<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Political Tendency Quiz</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NC4FEX4VK5"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-NC4FEX4VK5');
    </script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --background-color: #f5f6fa;
            --text-color: #2c3e50;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--background-color);
            color: var(--text-color);
            box-sizing: border-box;
            overflow-x: hidden;
            width: 100%;
        }

        .container {
            max-width: 800px;
            width: 95%;
            padding: 1.5rem;
            margin: 1rem auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
            box-sizing: border-box;
        }

        .container.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .question {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            text-align: center;
            line-height: 1.4;
            padding: 0 0.5rem;
        }

        .answers {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            padding: 0 0.5rem;
        }

        .answer-btn {
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: normal;
            text-align: center;
            min-height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .answer-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #eee;
            border-radius: 5px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--secondary-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        .loading {
            display: none;
            text-align: center;
        }

        .loading .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #results {
            display: none;
            text-align: center;
            padding: 0.5rem;
        }

        #results h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        #radarChart {
            max-width: 100%;
            max-height: 500px;
            width: 100%;
            height: 100%;
            margin: 1rem auto;
            padding: 0.5rem;
        }

        .start-screen {
            text-align: center;
            padding: 1rem 0.5rem;
        }

        .start-screen h1 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }

        .start-screen p {
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }

        .start-btn, .restart-btn {
            padding: 0.8rem 2rem;
            font-size: 1.1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-top: 1.5rem;
            width: 100%;
            max-width: 300px;
        }

        .start-btn:hover, .restart-btn:hover {
            transform: scale(1.05);
        }

        .share-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: nowrap;
            padding: 0 0.5rem;
        }

        .share-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            color: white;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.2s;
            text-decoration: none;
            position: relative;
        }

        .share-btn:hover {
            opacity: 0.9;
            transform: scale(1.1);
        }

        .share-btn i {
            font-size: 1.4rem;
        }

        .copy-url {
            background-color: #6c5ce7;
        }

        .copy-url.success {
            background-color: #00b894;
            transform: scale(1.1);
        }

        .copy-url.success i {
            animation: checkmark 0.5s ease-in-out;
        }

        @keyframes checkmark {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            bottom: -30px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .share-btn:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }

        .download {
            background-color: #2c3e50;
        }

        .whatsapp {
            background-color: #25D366;
        }

        .twitter {
            background-color: #000000;
            position: relative;
        }

        .twitter svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .tiktok {
            background: #000000;
            position: relative;
            overflow: hidden;
        }

        .tiktok::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #00f2ea, #ff0050);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tiktok:hover::before {
            opacity: 1;
        }

        .tiktok i {
            position: relative;
            z-index: 1;
        }

        @media (min-width: 768px) {
            .container {
                padding: 2rem;
                margin: 2rem auto;
            }

            .question {
                font-size: 1.5rem;
                padding: 0;
            }

            .answers {
                gap: 1rem;
                padding: 0;
            }

            .answer-btn {
                padding: 1rem 2rem;
                font-size: 1.1rem;
            }

            .start-btn, .restart-btn {
                padding: 1rem 3rem;
                font-size: 1.2rem;
                width: auto;
            }

            .start-screen h1 {
                font-size: 2.2rem;
            }

            .start-screen p {
                font-size: 1.2rem;
            }

            #results h2 {
                font-size: 2rem;
            }

            #radarChart {
                padding: 1rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                width: 100%;
                margin: 0;
                padding: 1rem;
                border-radius: 0;
            }

            .share-buttons {
                flex-direction: row;
                justify-content: center;
                gap: 0.8rem;
                margin-top: 1.5rem;
            }

            .share-btn {
                width: 40px;
                height: 40px;
            }

            .share-btn i {
                font-size: 1.2rem;
            }

            #radarChart {
                padding: 0;
                margin: 0.5rem auto;
            }

            .question {
                font-size: 1.1rem;
                padding: 0;
                margin-bottom: 1rem;
            }

            .answers {
                padding: 0;
            }

            .twitter svg {
                width: 20px;
                height: 20px;
            }
        }

        @media (max-width: 360px) {
            .share-btn {
                width: 35px;
                height: 35px;
            }

            .share-btn i {
                font-size: 1.1rem;
            }

            .share-buttons {
                gap: 0.6rem;
            }
        }

        .loading-text {
            margin-top: 15px;
        }
        
        .loading-text small {
            display: block;
            margin-top: 8px;
            opacity: 0.8;
            font-size: 0.9em;
        }

        .back-btn {
            padding: 0.7rem 1.5rem;
            font-size: 1rem;
            background: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1.5rem;
            width: auto;
            align-self: center;
        }

        .back-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .back-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .similar-figures {
            margin-top: 2rem;
            margin-bottom: 1.5rem;
            background-color: rgba(52, 152, 219, 0.1);
            padding: 1.2rem;
            border-radius: 10px;
            text-align: left;
        }
        
        .similar-figures h3 {
            color: var(--primary-color);
            text-align: center;
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .figure-matches {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        @media (min-width: 768px) {
            .figure-matches {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }
        }
        
        .figure-card {
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: white;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }
        
        .figure-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        
        @media (min-width: 768px) {
            .figure-card {
                flex: 0 0 calc(50% - 0.75rem);
                max-width: calc(50% - 0.75rem);
            }
        }
        
        .figure-image {
            width: 100%;
            height: 400px;
            object-fit: cover;
            object-position: top center;
            border-bottom: 2px solid var(--secondary-color);
        }
        
        .figure-content {
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .figure-name {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
            color: var(--primary-color);
        }
        
        .figure-country {
            font-size: 0.9rem;
            color: var(--secondary-color);
            margin-bottom: 0.7rem;
        }
        
        .figure-traits {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-bottom: 0.7rem;
        }
        
        .figure-trait {
            font-size: 0.7rem;
            background-color: rgba(52, 152, 219, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            color: var(--secondary-color);
        }
        
        .figure-description {
            margin-top: 0.5rem;
            margin-bottom: 0;
            font-size: 0.9rem;
            line-height: 1.4;
            color: #555;
        }

        .wiki-button {
            margin-top: auto;
            padding: 0.6rem;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            color: var(--primary-color);
            text-decoration: none;
            text-align: center;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .wiki-button:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .wiki-button svg {
            width: 16px;
            height: 16px;
        }

        .similarity-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--primary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1;
        }
    </style>
</head>
<body>
    <div class="container visible" id="mainContainer">
        <div class="start-screen" id="startScreen">
            <h1>Political Tendency Quiz</h1>
            <p>Discover your political leanings through this thoughtful quiz.</p>
            <button class="start-btn" onclick="startQuiz()">Start Quiz</button>
        </div>

        <div id="quizContent" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="question" id="questionText"></div>
            <div class="answers" id="answersContainer"></div>
            <button id="backButton" class="back-btn" onclick="goBack()" style="display: none;">Back</button>
        </div>

        <div class="loading" id="loadingScreen">
            <div class="spinner"></div>
            <p id="loadingText" class="loading-text">Calculating your results...</p>
        </div>

        <div id="results">
            <div id="results-content">
                <h2>Your Political Tendency Profile</h2>
                <canvas id="radarChart"></canvas>
                <div id="similarFigures" class="similar-figures"></div>
            </div>
            <button class="restart-btn" onclick="restartQuiz()">Take Quiz Again</button>
            
            <div class="share-buttons">
                <a href="#" class="share-btn download" onclick="downloadResults()" title="Download Results">
                    <i class="fas fa-download"></i>
                    <span class="tooltip">Download Image</span>
                </a>
                <a href="#" class="share-btn copy-url" onclick="copyShareUrl(this)" title="Copy URL">
                    <i class="fas fa-link"></i>
                    <span class="tooltip">Copy Link</span>
                </a>
                <a href="#" class="share-btn whatsapp" onclick="shareResults('whatsapp')" title="Share on WhatsApp">
                    <i class="fab fa-whatsapp"></i>
                    <span class="tooltip">Share on WhatsApp</span>
                </a>
                <a href="#" class="share-btn twitter" onclick="shareResults('twitter')" title="Share on X">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50">
                        <path d="M 5.9199219 6 L 20.582031 27.375 L 6.2304688 44 L 9.4101562 44 L 21.986328 29.421875 L 31.986328 44 L 44 44 L 28.681641 21.669922 L 42.199219 6 L 39.029297 6 L 27.275391 19.617188 L 17.933594 6 L 5.9199219 6 z M 9.7167969 8 L 16.880859 8 L 40.203125 42 L 33.039062 42 L 9.7167969 8 z"></path>
                    </svg>
                    <span class="tooltip">Share on X</span>
                </a>
                <a href="#" class="share-btn tiktok" onclick="shareResults('tiktok')" title="Share on TikTok">
                    <i class="fab fa-tiktok"></i>
                    <span class="tooltip">Share on TikTok</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Add Font Awesome for social icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <script>
        let questions = null;
        let currentStep = 1;
        let isSharedResult = false;
        let questionHistory = []; // Track previous questions and answers
        let scores = {
            Authority: 0, Liberty: 0,
            Security: 0, Openness: 0,
            Traditionalism: 0, Progressivism: 0,
            Nationalism: 0, Globalism: 0,
            Collectivism: 0, Individualism: 0,
            Equality: 0, Meritocracy: 0
        };

        // Define dimension labels as a global constant
        const dimensionLabels = {
            'Authority'      : 'Order‑Driven',
            'Liberty'        : 'Freedom‑Oriented',
            'Security'       : 'Safety‑Minded',
            'Openness'       : 'Open‑Minded',
            'Traditionalism' : 'Traditionalist',
            'Progressivism'  : 'Progressivist',
            'Nationalism'    : 'Nation‑Centric',
            'Globalism'      : 'World‑Centric',
            'Collectivism'   : 'Community‑Oriented',
            'Individualism'  : 'Individualist',
            'Equality'       : 'Fairness‑Focused',
            'Meritocracy'    : 'Meritocratic'
        };

        // Function to encode scores to compact string
        function encodeScores(scores) {
            // Version 1 prefix: v1_
            const VERSION = "1";
            
            // Order of values in the encoded string
            const order = [
                'Authority', 'Liberty',
                'Security', 'Openness',
                'Traditionalism', 'Progressivism',
                'Nationalism', 'Globalism',
                'Collectivism', 'Individualism',
                'Equality', 'Meritocracy'
            ];
            
            // Convert all scores to a single large number
            let totalNumber = 0;
            for (let i = 0; i < order.length; i++) {
                // Convert 0-100 to 0-99 range and shift left
                const value = Math.max(0, Math.min(99, Math.round(scores[order[i]])));
                totalNumber = totalNumber * 100 + value;
            }
            
            // Convert to base36 (0-9 and a-z)
            const encoded = totalNumber.toString(36);
            
            // Add version prefix
            return VERSION + encoded;
        }

        // Function to decode scores from compact string
        function decodeScores(encoded) {
            try {
                // Extract version and encoded value
                const version = encoded.charAt(0);
                const encodedValue = encoded.slice(1);
                
                if (version !== "1") {
                    console.error("Unsupported version");
                    return null;
                }

                const order = [
                    'Authority', 'Liberty',
                    'Security', 'Openness',
                    'Traditionalism', 'Progressivism',
                    'Nationalism', 'Globalism',
                    'Collectivism', 'Individualism',
                    'Equality', 'Meritocracy'
                ];

                // Convert from base36 back to decimal
                let totalNumber = parseInt(encodedValue, 36);
                
                // Extract individual scores
                const scores = {};
                for (let i = order.length - 1; i >= 0; i--) {
                    scores[order[i]] = totalNumber % 100;
                    totalNumber = Math.floor(totalNumber / 100);
                }
                
                return scores;
            } catch (e) {
                console.error("Error decoding scores:", e);
                return null;
            }
        }

        // Function to get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        async function loadQuestions() {
            const response = await fetch('questions.json');
            questions = await response.json();

            // Check for shared results in URL
            const sharedResults = getUrlParameter('r');
            if (sharedResults) {
                const decodedScores = decodeScores(sharedResults);
                if (decodedScores) {
                    isSharedResult = true;
                    scores = decodedScores;
                    
                    // Track landing from shared link
                    gtag('event', 'shared_link_landing', {
                        'event_category': 'traffic',
                        'event_label': 'Shared Link View'
                    });
                    
                    document.getElementById('startScreen').style.display = 'none';
                    showLoadingScreen();
                    return;
                }
            }

            document.getElementById('mainContainer').classList.add('visible');
        }

        function startQuiz() {
            // Track quiz start
            gtag('event', 'quiz_started', {
                'event_category': 'quiz_progress',
                'event_label': 'Quiz Started'
            });
            
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('quizContent').style.display = 'block';
            showQuestion();
        }

        function showQuestion() {
            const container = document.getElementById('mainContainer');
            container.classList.remove('visible');
            
            setTimeout(() => {
                const stepQuestions = questions[currentStep].questions;
                const randomQuestion = stepQuestions[Math.floor(Math.random() * stepQuestions.length)];
                
                document.getElementById('questionText').textContent = randomQuestion.question;
                
                const answersContainer = document.getElementById('answersContainer');
                answersContainer.innerHTML = '';
                
                ['Yes', 'No', 'Neutral'].forEach(answer => {
                    const button = document.createElement('button');
                    button.className = 'answer-btn';
                    button.textContent = answer;
                    button.onclick = () => handleAnswer(randomQuestion, answer);
                    answersContainer.appendChild(button);
                });

                document.getElementById('progressFill').style.width = `${((currentStep - 1) / 9) * 100}%`;
                
                // Show back button if not on first question
                const backButton = document.getElementById('backButton');
                if (questionHistory.length > 0) {
                    backButton.style.display = 'block';
                } else {
                    backButton.style.display = 'none';
                }
                
                container.classList.add('visible');
            }, 500);
        }

        function handleAnswer(question, answerText) {
            const answerScores = question.answers[answerText];
            
            // Save current question and answer to history
            questionHistory.push({
                step: currentStep,
                question: question,
                answer: answerText
            });
            
            // Track this step completion
            gtag('event', 'quiz_step_completed', {
                'event_category': 'quiz_progress',
                'event_label': `Step ${currentStep} of 9`,
                'step_number': currentStep,
                'step_percentage': Math.round((currentStep / 9) * 100),
                'question_text': question.question.substring(0, 50) + (question.question.length > 50 ? '...' : ''),
                'answer_selected': answerText
            });
            
            Object.entries(answerScores).forEach(([attribute, score]) => {
                scores[attribute] += score;
            });

            if (currentStep < 9) {
                currentStep++;
                showQuestion();
            } else {
                showLoadingScreen();
            }
        }

        function showLoadingScreen() {
            document.getElementById('quizContent').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'block';
            
            // Update loading text based on context
            const loadingText = document.getElementById('loadingText');
            if (isSharedResult) {
                loadingText.innerHTML = 'Loading shared profile...<br><small>Someone shared their political tendency profile with you!</small>';
            } else {
                loadingText.textContent = 'Calculating your results...';
            }

            setTimeout(showResults, 1500);
        }

        function normalizeScores() {
            // Find min and max for each pair of opposing values
            const pairs = {
                'Authority-Liberty': ['Authority', 'Liberty'],
                'Security-Openness': ['Security', 'Openness'],
                'Traditionalism-Progressivism': ['Traditionalism', 'Progressivism'],
                'Nationalism-Globalism': ['Nationalism', 'Globalism'],
                'Collectivism-Individualism': ['Collectivism', 'Individualism'],
                'Equality-Meritocracy': ['Equality', 'Meritocracy']
            };

            const normalized = {};
            
            // Normalize each pair
            Object.values(pairs).forEach(([attr1, attr2]) => {
                const total = Math.abs(scores[attr1]) + Math.abs(scores[attr2]);
                if (total === 0) {
                    // If both scores are 0, set them to 50 (neutral)
                    normalized[attr1] = 50;
                    normalized[attr2] = 50;
                } else {
                    // Convert to percentage but maintain the relationship
                    normalized[attr1] = (scores[attr1] / total * 100 + 100) / 2;
                    normalized[attr2] = (scores[attr2] / total * 100 + 100) / 2;
                }
            });
            
            return normalized;
        }

        let chartInstance = null; // Keep track of chart instance

        function showResults() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('results').style.display = 'block';

            // For display purposes only
            const normalizedScores = normalizeScores();
            
            // Update URL with encoded results - using RAW scores, not normalized
            if (!isSharedResult) {
                try {
                    const encodedResults = encodeScores(scores);
                    const newUrl = window.location.pathname + '?r=' + encodedResults;
                    window.history.pushState({ scores: scores }, 'Quiz Results', newUrl);
                    console.log("URL updated with raw scores");
                } catch (error) {
                    console.error("Error updating URL:", error);
                }
            }
            
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            // Destroy previous chart if it exists
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // Create a mapping of original keys to display labels and define the order
            const dimensionOrder = [
                'Globalism',       
                'Progressivism',        
                'Nationalism',        
                'Individualism',   
                'Meritocracy',     
                'Traditionalism',  
                'Authority',       
                'Security',        
                'Liberty',         
                'Collectivism',     
                'Equality',        
                'Openness'    
            ];

            chartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: dimensionOrder.map(key => dimensionLabels[key]),
                    datasets: [{
                        label: 'Your Political Profile',
                        data: dimensionOrder.map(key => normalizedScores[key]),
                        fill: true,
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        pointBackgroundColor: 'rgba(52, 152, 219, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(52, 152, 219, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    layout: {
                        padding: {
                            top: 40,
                            right: 40,
                            bottom: 40,
                            left: 40
                        }
                    },
                    elements: {
                        line: {
                            borderWidth: 3
                        }
                    },
                    scales: {
                        r: {
                            angleLines: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: {
                                font: {
                                    size: 12
                                },
                                stepSize: 20,
                                showLabelBackdrop: true,
                                backdropColor: 'rgba(255, 255, 255, 0.75)'
                            },
                            pointLabels: {
                                font: {
                                    size: 12
                                },
                                centerPointLabels: false,
                                padding: 25,
                                display: true,
                                callback: function(value, index) {
                                    return value.split('‑');
                                },
                                textAlign: 'center'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: 20
                            }
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: function(context) {
                                    return `Score: ${Math.round(context.raw)}%`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Find and display similar public figures
            findSimilarFigures(normalizedScores);
        }

        // Modify the publicFigures array to remove image and wiki URLs
        
        const publicFigures = [
        {
            name: "Mao Zedong",
            country: "China",
            traits: {
                'Authority': 1.0,
                'Collectivism': 1.0,
                'Globalism': 0.2,
                'Progressivism': 0.2,
                'Nationalism': 0.2,
                'Individualism': 0.2,
                'Meritocracy': 0.3,
                'Traditionalism': 0.2,
                'Security': 0.3,
                'Liberty': 0.1,
                'Equality': 0.1,
                'Openness': 0.2
            },
            description: "Led Communist China with strong state control and collectivist policy."
        },
        {
            name: "Margaret Thatcher",
            country: "U.K.",
            traits: {
                'Individualism': 1.0,
                'Meritocracy': 1.0,
                'Globalism': 0.2,
                'Progressivism': 0.1,
                'Nationalism': 0.3,
                'Traditionalism': 0.4,
                'Authority': 0.2,
                'Security': 0.3,
                'Liberty': 0.2,
                'Collectivism': 0.1,
                'Equality': 0.1,
                'Openness': 0.1
            },
            description: "Free-market champion who believed in personal responsibility and merit."
        },
        {
            name: "Nelson Mandela",
            country: "S. Africa",
            traits: {
                'Progressivism': 1.0,
                'Equality': 1.0,
                'Globalism': 0.3,
                'Nationalism': 0.2,
                'Individualism': 0.3,
                'Meritocracy': 0.2,
                'Traditionalism': 0.1,
                'Authority': 0.2,
                'Security': 0.2,
                'Liberty': 0.2,
                'Collectivism': 0.2,
                'Openness': 0.1
            },
            description: "Progressive leader who dismantled apartheid and promoted equality."
        },
        {
            name: "Mahatma Gandhi",
            country: "India",
            traits: {
                'Liberty': 1.0,
                'Traditionalism': 1.0,
                'Globalism': 0.2,
                'Progressivism': 0.3,
                'Individualism': 0.3,
                'Meritocracy': 0.1,
                'Nationalism': 0.3,
                'Authority': 0.1,
                'Security': 0.2,
                'Collectivism': 0.2,
                'Equality': 0.1,
                'Openness': 0.2
            },
            description: "Non-violent nationalist who led India to freedom with civil disobedience."
        },
        {
            name: "Mustafa Kemal Atatürk",
            country: "Turkey",
            traits: {
                'Nationalism': 1.0,
                'Progressivism': 1.0,
                'Globalism': 0.3,
                'Individualism': 0.3,
                'Meritocracy': 0.2,
                'Traditionalism': 0.2,
                'Authority': 0.3,
                'Security': 0.2,
                'Liberty': 0.2,
                'Collectivism': 0.1,
                'Equality': 0.1,
                'Openness': 0.1
            },
            description: "Modernizer who combined secular reforms with Turkish nationalism."
        },
        {
            name: "Che Guevara",
            country: "Argentina/Cuba",
            traits: {
                'Globalism': 1.0,
                'Collectivism': 1.0,
                'Progressivism': 0.3,
                'Nationalism': 0.2,
                'Individualism': 0.1,
                'Meritocracy': 0.2,
                'Traditionalism': 0.2,
                'Authority': 0.3,
                'Security': 0.3,
                'Liberty': 0.1,
                'Equality': 0.1,
                'Openness': 0.2
            },
            description: "Revolutionary figure who symbolized global socialism and collective struggle."
        },
        {
            name: "Ayn Rand",
            country: "USA",
            traits: {
                'Individualism': 1.0,
                'Openness': 1.0,
                'Globalism': 0.1,
                'Progressivism': 0.2,
                'Nationalism': 0.2,
                'Meritocracy': 0.4,
                'Traditionalism': 0.2,
                'Authority': 0.2,
                'Security': 0.1,
                'Collectivism': 0.0,
                'Equality': 0.1,
                'Liberty': 0.5
            },
            description: "Objectivist thinker who emphasized liberty and radical individualism."
        },
        {
            name: "Ruhollah Khomeini",
            country: "Iran",
            traits: {
                'Traditionalism': 1.0,
                'Authority': 1.0,
                'Globalism': 0.3,
                'Progressivism': 0.2,
                'Nationalism': 0.2,
                'Individualism': 0.1,
                'Meritocracy': 0.2,
                'Security': 0.2,
                'Liberty': 0.1,
                'Collectivism': 0.2,
                'Equality': 0.1,
                'Openness': 0.3
            },
            description: "Islamic revolutionary who established a theocratic regime rooted in tradition."
        },
        {
            name: "Martin Luther King Jr.",
            country: "USA",
            traits: {
                'Liberty': 1.0,
                'Equality': 1.0,
                'Globalism': 0.2,
                'Progressivism': 0.3,
                'Nationalism': 0.1,
                'Individualism': 0.3,
                'Meritocracy': 0.3,
                'Traditionalism': 0.1,
                'Authority': 0.1,
                'Security': 0.2,
                'Collectivism': 0.2,
                'Openness': 0.2
            },
            description: "Civil rights leader who championed liberty and racial justice."
        },
        {
            name: "Winston Churchill",
            country: "U.K.",
            traits: {
                'Security': 1.0,
                'Nationalism': 1.0,
                'Globalism': 0.3,
                'Progressivism': 0.2,
                'Individualism': 0.2,
                'Meritocracy': 0.2,
                'Traditionalism': 0.3,
                'Authority': 0.3,
                'Liberty': 0.2,
                'Collectivism': 0.1,
                'Equality': 0.1,
                'Openness': 0.1
            },
            description: "Resolute wartime leader who embodied British authority and national pride."
        },
        {
            name: "Eleanor Roosevelt",
            country: "USA",
            traits: {
                'Globalism': 1.0,
                'Openness': 1.0,
                'Progressivism': 0.3,
                'Nationalism': 0.1,
                'Individualism': 0.3,
                'Meritocracy': 0.2,
                'Traditionalism': 0.1,
                'Authority': 0.2,
                'Security': 0.2,
                'Liberty': 0.3,
                'Collectivism': 0.1,
                'Equality': 0.1
            },
            description: "Visionary global advocate for human rights and inclusion."
        },
        {
            name: "Simón Bolívar",
            country: "South America",
            traits: {
                'Security': 1.0,
                'Meritocracy': 1.0,
                'Globalism': 0.2,
                'Progressivism': 0.3,
                'Nationalism': 0.3,
                'Individualism': 0.2,
                'Traditionalism': 0.2,
                'Authority': 0.2,
                'Liberty': 0.2,
                'Collectivism': 0.1,
                'Equality': 0.1,
                'Openness': 0.1
            },
            description: "Liberator of Latin America who valued merit and state resilience."
        }
    ];
    

        // Separate image URL map
        const figureImageUrls = {
            "Mao Zedong": "https://upload.wikimedia.org/wikipedia/commons/7/7e/Mao_Zedong_in_1957_%28cropped%29.jpg",
            "Margaret Thatcher": "https://upload.wikimedia.org/wikipedia/commons/thumb/3/3d/Margaret_Thatcher_stock_portrait_%28cropped%29.jpg/500px-Margaret_Thatcher_stock_portrait_%28cropped%29.jpg",
            "Nelson Mandela": "https://upload.wikimedia.org/wikipedia/commons/0/02/Nelson_Mandela_1994.jpg",
            "Mahatma Gandhi": "https://upload.wikimedia.org/wikipedia/commons/7/7a/Mahatma-Gandhi%2C_studio%2C_1931.jpg",
            "Mustafa Kemal Atatürk": "https://upload.wikimedia.org/wikipedia/commons/a/a8/Ataturk1930s.jpg",
            "Che Guevara": "https://upload.wikimedia.org/wikipedia/commons/5/58/CheHigh.jpg",
            "Ayn Rand": "https://upload.wikimedia.org/wikipedia/commons/thumb/b/b1/Ayn_Rand_%281943_Talbot_portrait%29.jpg/500px-Ayn_Rand_%281943_Talbot_portrait%29.jpg",
            "Jacinda Ardern": "https://upload.wikimedia.org/wikipedia/commons/b/b6/New_Zealand_Prime_Minister_Jacinda_Ardern_in_2018.jpg",
            "Ruhollah Khomeini": "https://upload.wikimedia.org/wikipedia/commons/thumb/c/cb/Portrait_of_Ruhollah_Khomeini.jpg/500px-Portrait_of_Ruhollah_Khomeini.jpg",
            "Angela Merkel": "https://upload.wikimedia.org/wikipedia/commons/thumb/0/0f/Angela_Merkel_2019_cropped.jpg/500px-Angela_Merkel_2019_cropped.jpg",
            "Lee Kuan Yew": "https://upload.wikimedia.org/wikipedia/commons/thumb/2/2f/Prime_Minister_Lee_Kuan_Yew_of_Singapore_Making_a_Toast_at_a_State_Dinner_Held_in_His_Honor%2C_1975.jpg/500px-Prime_Minister_Lee_Kuan_Yew_of_Singapore_Making_a_Toast_at_a_State_Dinner_Held_in_His_Honor%2C_1975.jpg",
            "Martin Luther King Jr.": "https://upload.wikimedia.org/wikipedia/commons/0/05/Martin_Luther_King%2C_Jr..jpg",
            "Joseph Stalin": "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5b/Joseph_Stalin_in_1932_%284%29_%28cropped%29%282%29.jpg/500px-Joseph_Stalin_in_1932_%284%29_%28cropped%29%282%29.jpg",
            "Vladimir Putin": "https://upload.wikimedia.org/wikipedia/commons/thumb/5/57/%D0%92%D0%BB%D0%B0%D0%B4%D0%B8%D0%BC%D0%B8%D1%80_%D0%9F%D1%83%D1%82%D0%B8%D0%BD_%2808-03-2024%29_%28cropped%29_%28higher_res%29.jpg/500px-%D0%92%D0%BB%D0%B0%D0%B4%D0%B8%D0%BC%D0%B8%D1%80_%D0%9F%D1%83%D1%82%D0%B8%D0%BD_%2808-03-2024%29_%28cropped%29_%28higher_res%29.jpg",
            "Donald Trump": "https://upload.wikimedia.org/wikipedia/commons/thumb/8/83/TrumpPortrait.jpg/500px-TrumpPortrait.jpg",
            "Greta Thunberg": "https://upload.wikimedia.org/wikipedia/commons/thumb/1/13/Greta_Thunberg_Stockholm_2024_%283x4_cropped%29.jpg/500px-Greta_Thunberg_Stockholm_2024_%283x4_cropped%29.jpg",
            "Malala Yousafzai": "https://upload.wikimedia.org/wikipedia/commons/thumb/0/03/Malala_Yousafzai_2023_portrait_2x3.jpg/500px-Malala_Yousafzai_2023_portrait_2x3.jpg",
            "Pope Francis": "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ab/Pope_Francis_Korea_Haemi_Castle_19.jpg/500px-Pope_Francis_Korea_Haemi_Castle_19.jpg",
            "Xi Jinping": "https://upload.wikimedia.org/wikipedia/commons/thumb/0/04/Xi_Jinping_%28November_2024%29_02.jpg/500px-Xi_Jinping_%28November_2024%29_02.jpg",
            "Elon Musk": "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f4/USAFA_Hosts_Elon_Musk_%28Image_1_of_17%29_%28cropped%29.jpg/500px-USAFA_Hosts_Elon_Musk_%28Image_1_of_17%29_%28cropped%29.jpg",
            "Winston Churchill": "https://upload.wikimedia.org/wikipedia/commons/thumb/b/bc/Sir_Winston_Churchill_-_19086236948.jpg/500px-Sir_Winston_Churchill_-_19086236948.jpg",
            "Eleanor Roosevelt": "https://upload.wikimedia.org/wikipedia/commons/thumb/2/22/Eleanor_Roosevelt_portrait_1933.jpg/500px-Eleanor_Roosevelt_portrait_1933.jpg",
            "Simón Bolívar": "https://upload.wikimedia.org/wikipedia/commons/thumb/3/38/Sim%C3%B3n_Bol%C3%ADvar._Toro_Moreno%2C_Jos%C3%A9._1922%2C_Legislative_Palace%2C_La_Paz.png/500px-Sim%C3%B3n_Bol%C3%ADvar._Toro_Moreno%2C_Jos%C3%A9._1922%2C_Legislative_Palace%2C_La_Paz.png"
        };

        // Separate wiki URL map
        const figureWikiUrls = {
            "Mao Zedong": "https://en.wikipedia.org/wiki/Mao_Zedong",
            "Margaret Thatcher": "https://en.wikipedia.org/wiki/Margaret_Thatcher",
            "Nelson Mandela": "https://en.wikipedia.org/wiki/Nelson_Mandela",
            "Mahatma Gandhi": "https://en.wikipedia.org/wiki/Mahatma_Gandhi",
            "Mustafa Kemal Atatürk": "https://en.wikipedia.org/wiki/Mustafa_Kemal_Atatürk",
            "Che Guevara": "https://en.wikipedia.org/wiki/Che_Guevara",
            "Ayn Rand": "https://en.wikipedia.org/wiki/Ayn_Rand",
            "Jacinda Ardern": "https://en.wikipedia.org/wiki/Jacinda_Ardern",
            "Ruhollah Khomeini": "https://en.wikipedia.org/wiki/Ruhollah_Khomeini",
            "Angela Merkel": "https://en.wikipedia.org/wiki/Angela_Merkel",
            "Lee Kuan Yew": "https://en.wikipedia.org/wiki/Lee_Kuan_Yew",
            "Martin Luther King Jr.": "https://en.wikipedia.org/wiki/Martin_Luther_King_Jr.",
            "Joseph Stalin": "https://en.wikipedia.org/wiki/Joseph_Stalin",
            "Vladimir Putin": "https://en.wikipedia.org/wiki/Vladimir_Putin",
            "Donald Trump": "https://en.wikipedia.org/wiki/Donald_Trump",
            "Greta Thunberg": "https://en.wikipedia.org/wiki/Greta_Thunberg",
            "Malala Yousafzai": "https://en.wikipedia.org/wiki/Malala_Yousafzai",
            "Pope Francis": "https://en.wikipedia.org/wiki/Pope_Francis",
            "Xi Jinping": "https://en.wikipedia.org/wiki/Xi_Jinping",
            "Elon Musk": "https://en.wikipedia.org/wiki/Elon_Musk",
            "Winston Churchill": "https://en.wikipedia.org/wiki/Winston_Churchill",
            "Eleanor Roosevelt": "https://en.wikipedia.org/wiki/Eleanor_Roosevelt",
            "Simón Bolívar": "https://en.wikipedia.org/wiki/Sim%C3%B3n_Bol%C3%ADvar"
        };

        // Calculate cosine similarity between two vectors
        function calculateCosineSimilarity(vectorA, userScores, figureTraits) {
            // All traits to check
            const allTraits = [
                'Authority', 'Liberty',
                'Security', 'Openness',
                'Traditionalism', 'Progressivism',
                'Nationalism', 'Globalism',
                'Collectivism', 'Individualism',
                'Equality', 'Meritocracy'
            ];
            
            // Create vectors from trait objects
            const userVector = allTraits.map(trait => userScores[trait] || 50);
            const figureVector = allTraits.map(trait => (figureTraits[trait] || 0) * 100); // Scale 0-1 to 0-100
            
            // Calculate magnitudes
            const magnitudeA = Math.sqrt(userVector.reduce((sum, val) => sum + val * val, 0));
            const magnitudeB = Math.sqrt(figureVector.reduce((sum, val) => sum + val * val, 0));
            
            // Handle zero vectors to avoid division by zero
            if (magnitudeA === 0 || magnitudeB === 0) {
                return 0;
            }
            
            // Normalize vectors to unit vectors
            const normalizedA = userVector.map(val => val / magnitudeA);
            const normalizedB = figureVector.map(val => val / magnitudeB);
            
            // Calculate dot product of normalized vectors
            let dotProduct = 0;
            for (let i = 0; i < normalizedA.length; i++) {
                dotProduct += normalizedA[i] * normalizedB[i];
            }
            
            // Return cosine similarity (dot product of normalized vectors)
            return dotProduct;
        }

        // Find similar public figures based on user's scores
        function findSimilarFigures(normalizedScores) {
            // Calculate similarity scores for each figure using cosine similarity
            const similarities = publicFigures.map(figure => {
                // Calculate cosine similarity with normalized vectors
                const cosineSimilarity = calculateCosineSimilarity([], normalizedScores, figure.traits);
                
                return {
                    figure: figure,
                    score: cosineSimilarity
                };
            });
            
            // Sort by similarity score (highest first)
            similarities.sort((a, b) => b.score - a.score);
            
            // Take top matches
            const topMatches = similarities.slice(0, 2);
            
            // Track quiz completion with top 2 figures (only for users who completed the quiz, not direct URL landings)
            if (!isSharedResult) {
                gtag('event', 'quiz_completion', {
                    'event_category': 'quiz',
                    'event_label': 'Results',
                    'top_figure_1': topMatches[0]?.figure?.name || 'Unknown',
                    'top_figure_2': topMatches[1]?.figure?.name || 'Unknown',
                    'match_score_1': Math.round((topMatches[0]?.score || 0) * 100),
                    'match_score_2': Math.round((topMatches[1]?.score || 0) * 100)
                });
            }
            
            // Display the matches
            displaySimilarFigures(topMatches);
        }
        
        // Display the similar figures in the results
        function displaySimilarFigures(matches) {
            // Create container if it doesn't exist
            let figuresContainer = document.getElementById('similarFigures');
            if (!figuresContainer) {
                figuresContainer = document.createElement('div');
                figuresContainer.id = 'similarFigures';
                figuresContainer.className = 'similar-figures';
                
                // Add heading
                const heading = document.createElement('h3');
                heading.textContent = 'Your Political Tendencies Resemble:';
                figuresContainer.appendChild(heading);
                
                // Insert after radar chart but before buttons
                const resultsDiv = document.getElementById('results');
                const restartButton = document.querySelector('.restart-btn');
                resultsDiv.insertBefore(figuresContainer, restartButton);
            } else {
                // Clear existing content
                figuresContainer.innerHTML = '';
                const heading = document.createElement('h3');
                heading.textContent = 'Your Political Tendencies Resemble:';
                figuresContainer.appendChild(heading);
            }
            
            // Create container for figure cards
            const matchesContainer = document.createElement('div');
            matchesContainer.className = 'figure-matches';
            figuresContainer.appendChild(matchesContainer);
            
            // Add each match
            matches.forEach((match, index) => {
                const figure = match.figure;
                
                // Create card container
                const card = document.createElement('div');
                card.className = 'figure-card';
                
                // Add similarity badge
                const similarityBadge = document.createElement('div');
                similarityBadge.className = 'similarity-badge';
                // Convert similarity score to percentage (0 to 100)
                const similarityPercent = Math.round(match.score * 100);
                similarityBadge.textContent = `${similarityPercent}% match`;
                card.appendChild(similarityBadge);
                
                // Add image
                const img = document.createElement('img');
                img.src = figureImageUrls[figure.name] || 'https://via.placeholder.com/400x250?text=Image+Not+Available';
                img.alt = figure.name;
                img.className = 'figure-image';
                img.onerror = function() {
                    //this.src = 'https://via.placeholder.com/400x250?text=Image+Not+Available';
                };
                card.appendChild(img);
                
                // Add content container
                const content = document.createElement('div');
                content.className = 'figure-content';
                
                // Add name
                const name = document.createElement('div');
                name.className = 'figure-name';
                name.textContent = figure.name;
                content.appendChild(name);
                
                // Add country
                const country = document.createElement('div');
                country.className = 'figure-country';
                const flagEmoji = getCountryFlag(figure.country);
                country.innerHTML = `${flagEmoji} ${figure.country}`;
                content.appendChild(country);
                
                // Add traits
                const traits = document.createElement('div');
                traits.className = 'figure-traits';
                
                // Get top 3 traits for this figure
                const topTraits = getTopTraits(figure);
                
                // Add each top trait as a badge
                topTraits.forEach(traitInfo => {
                    const traitBadge = document.createElement('span');
                    traitBadge.className = 'figure-trait';
                    // Use dimensionLabels instead of raw trait names
                    const formattedTrait = dimensionLabels[traitInfo.trait] || traitInfo.trait;
                    traitBadge.textContent = `${formattedTrait}`;
                    traits.appendChild(traitBadge);
                });
                
                content.appendChild(traits);
                
                // Add description
                const desc = document.createElement('p');
                desc.className = 'figure-description';
                desc.textContent = figure.description;
                content.appendChild(desc);
                
                // Add Wikipedia button
                const wikiUrl = figureWikiUrls[figure.name];
                if (wikiUrl) {
                    const wikiButton = document.createElement('a');
                    wikiButton.href = wikiUrl;
                    wikiButton.target = "_blank";
                    wikiButton.rel = "noopener noreferrer";
                    wikiButton.className = 'wiki-button';
                    
                    // Use official Wikipedia 'W' logo
                    wikiButton.innerHTML = `
                        <img src="https://upload.wikimedia.org/wikipedia/commons/5/5a/Wikipedia%27s_W.svg" alt="Wikipedia" width="16" height="16">
                        Read on Wikipedia
                    `;
                    
                    content.appendChild(wikiButton);
                }
                
                // Add card to content
                card.appendChild(content);
                
                // Add card to container
                matchesContainer.appendChild(card);
            });
        }

        // Function to get country flag emoji
        function getCountryFlag(countryName) {
            // Map of country names to ISO 3166-1 Alpha-2 codes for flag emojis
            const countryCodeMap = {
                "China": "CN",
                "U.K.": "GB",
                "S. Africa": "ZA",
                "India": "IN",
                "Turkey": "TR",
                "Argentina": "AR",
                "Cuba": "CU",
                "Argentina/Cuba": "CU",
                "USA": "US",
                "N. Zealand": "NZ",
                "Iran": "IR",
                "Germany": "DE",
                "Singapore": "SG",
                "USSR": "RU",
                "Russia": "RU",
                "Sweden": "SE",
                "Pakistan": "PK",
                "Vatican": "VA",
                "Vatican/Argentina": "VA",
                "Brazil": "BR",
                "Philippines": "PH",
                "USA/S. Africa": "US",
                "South America": "VE",
            };
            
            // Special case for combined countries
            if (countryName.includes("/")) {
                const primaryCountry = countryName.split("/")[0];
                countryName = primaryCountry;
            }
            
            const code = countryCodeMap[countryName];
            
            if (!code) return "";
            
            // Convert country code to regional indicator symbols (flag emoji)
            // Each letter is represented by a regional indicator symbol, which is 127397 code points after its ASCII value
            const codePoints = [...code].map(char => 127397 + char.charCodeAt(0));
            return String.fromCodePoint(...codePoints);
        }

        // Function to get top traits for a figure
        function getTopTraits(figure) {
            // Convert object to array of {trait, score} objects
            const traitScores = Object.entries(figure.traits).map(([trait, score]) => ({
                trait: trait,
                score: score
            }));
            
            // Sort by score (descending) and get top 3
            return traitScores.sort((a, b) => b.score - a.score).slice(0, 3);
        }

        function restartQuiz() {
            // Track quiz restart
            gtag('event', 'quiz_restart', {
                'event_category': 'quiz_progress',
                'event_label': 'Quiz Restarted'
            });
            
            // Destroy chart instance if it exists
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
            
            // Clean up URL by removing query parameters
            const baseUrl = window.location.pathname;
            window.history.pushState({}, document.title, baseUrl);
            
            // Reset all variables
            currentStep = 1;
            questionHistory = []; // Clear question history
            scores = {
                Authority: 0, Liberty: 0,
                Security: 0, Openness: 0,
                Traditionalism: 0, Progressivism: 0,
                Nationalism: 0, Globalism: 0,
                Collectivism: 0, Individualism: 0,
                Equality: 0, Meritocracy: 0
            };
            
            // Clear answer buttons to prevent pre-selected answers on retake
            document.getElementById('answersContainer').innerHTML = '';
            
            // Hide results and show start screen
            document.getElementById('results').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('quizContent').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'none';
            
            // Reset progress bar
            document.getElementById('progressFill').style.width = '0%';
            
            // Ensure container is visible
            document.getElementById('mainContainer').classList.add('visible');
        }

        async function downloadResults() {
            // Add html2canvas script if it's not already in the page
            if (!window.html2canvas) {
                return new Promise((resolve) => {
                    const script = document.createElement('script');
                    script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
                    script.onload = () => {
                        downloadResultsContent().then(resolve);
                    };
                    document.head.appendChild(script);
                });
            } else {
                return downloadResultsContent();
            }
        }

        async function downloadResultsContent() {
            const resultsContent = document.getElementById('results-content');
            
            try {
                const canvas = await html2canvas(resultsContent, {
                    backgroundColor: 'white',
                    scale: 2, // Higher quality
                    useCORS: true, // To handle external images
                    logging: false
                });
                
                const link = document.createElement('a');
                link.download = 'political-tendency-profile.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (error) {
                console.error('Error generating image:', error);
                // Fallback to just the chart if html2canvas fails
                const imageData = await generateResultImage();
                const link = document.createElement('a');
                link.download = 'political-tendency-profile.png';
                link.href = imageData;
                link.click();
            }
        }

        async function generateResultImage() {
            const chartCanvas = document.getElementById('radarChart');
            const chartImage = chartCanvas.toDataURL('image/png');
            
            // Create a temporary canvas
            const tempCanvas = document.createElement('canvas');
            const ctx = tempCanvas.getContext('2d');
            tempCanvas.width = chartCanvas.width;
            tempCanvas.height = chartCanvas.height + 60;
            
            // Fill background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // Add the chart
            const chartImg = new Image();
            chartImg.src = chartImage;
            
            return new Promise(resolve => {
                chartImg.onload = function() {
                    ctx.drawImage(chartImg, 0, 0);
                    
                    // Add title
                    ctx.fillStyle = '#2c3e50';
                    ctx.font = 'bold 16px "Segoe UI", sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('My Political Tendency Profile', tempCanvas.width/2, tempCanvas.height - 30);
                    
                    resolve(tempCanvas.toDataURL('image/png'));
                };
            });
        }

        async function shareResults(platform) {
            const baseUrl = window.location.origin + window.location.pathname;
            // Always use raw scores for encoding
            const encodedResults = encodeScores(scores);
            const shareUrl = `${baseUrl}?r=${encodedResults}`;
            const text = 'My Political Profile:';
            
            // Track share event
            gtag('event', 'share', {
                'event_category': 'engagement',
                'event_label': platform
            });
            
            switch (platform) {
                case 'whatsapp':
                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: 'Political Profile',
                                text: text,
                                url: shareUrl
                            });
                        } catch (err) {
                            window.open(`https://wa.me/?text=${encodeURIComponent(text + ' ' + shareUrl)}`, '_blank');
                        }
                    } else {
                        window.open(`https://wa.me/?text=${encodeURIComponent(text + ' ' + shareUrl)}`, '_blank');
                    }
                    break;
                case 'twitter':
                    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(shareUrl)}`, '_blank');
                    break;
                case 'tiktok':
                    try {
                        await navigator.clipboard.writeText(text + ' ' + shareUrl);
                        alert('Link copied! You can now paste it on TikTok');
                    } catch (err) {
                        window.open('https://www.tiktok.com', '_blank');
                    }
                    break;
            }
        }

        async function copyShareUrl(button) {
            const baseUrl = window.location.origin + window.location.pathname;
            // Always use raw scores for encoding
            const encodedResults = encodeScores(scores);
            const shareUrl = `${baseUrl}?r=${encodedResults}`;
            
            try {
                await navigator.clipboard.writeText(shareUrl);
                
                // Visual feedback
                button.classList.add('success');
                const icon = button.querySelector('i');
                icon.classList.remove('fa-link');
                icon.classList.add('fa-check');
                
                // Reset after 2 seconds
                setTimeout(() => {
                    button.classList.remove('success');
                    icon.classList.remove('fa-check');
                    icon.classList.add('fa-link');
                }, 2000);
                
                console.log("Share URL copied with raw scores");
                
            } catch (err) {
                console.error("Error copying URL:", err);
                alert('Failed to copy URL. Please try again.');
            }
        }

        function goBack() {
            if (questionHistory.length === 0) return;
            
            // Get the last answered question
            const lastAnswer = questionHistory.pop();
            
            // Revert the score changes
            const answerScores = lastAnswer.question.answers[lastAnswer.answer];
            Object.entries(answerScores).forEach(([attribute, score]) => {
                scores[attribute] -= score;
            });
            
            // Go back to previous step
            currentStep = lastAnswer.step;
            
            // Show question again
            showQuestion();
        }

        // Initialize the quiz
        loadQuestions().then(() => {
            document.getElementById('mainContainer').classList.add('visible');
        });
    </script>
</body>
</html> 